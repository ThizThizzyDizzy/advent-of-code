package aoc2021;
import java.util.HashMap;
public class Day20 implements Day{
    @Override
    public void run(){
        String key = "#.#.....##...##..#.#......#.#...#.#.#...###.##......###.##.##..##.#...#.....###.#.....#.#.#...#.#..###.###..###..#..##..###..##..##.##.#..###########.##....#.#......#...#.###..###...#.####..########.#####.#.#..##.##.##..###.##.####.#..##.##..#...#####..#.#.##.##...##..#..##.....###.#.#....####.##.#...##.########.#.##.#.....###....#..###.####....############.#.##...#.####...#...##.#.#..#..#......#..##...#.########.#.#...#####..#..######.#.#.....#####...##.###.#.#.##.........#.#.##..##.#..#..##..##.###.##.##.";
        String img = """
                     #.#...##.#.##.##...#......##....##...#.#....##.##.#.##....###.#####.#......###......#.#.##.####..#.#
                     #.#...###.#.#.#...##...###....#####.#...#.####..########.#.#.#..#.###..##..#.####....#.#..#..##.####
                     .....#.######..#.#.....#..#..####.########..#.#.####..#####..##.#..##..##.##.#..###.#.#.#.#...#..###
                     #.#........#.###.#..######.##..#.##...#.....#.#.......#.##.....#.###.##.#..##..#.##...##...##.####..
                     #...#.#.##..###..#..####..#####.##...###.#....#..###..#.#....####..####.####..#..###.####.###.#..###
                     #..###..##.#....#.##..##.#..#.##....#.#.#.##..#.#.##..#..##.....#####..#..##.##.##..#.#####.###.#...
                     ..####..##...#....##.#...#######..#....##.###...#.#.........##........###.#.##....#.#.###...#...###.
                     #######..#......##...##..###..##.#..##.#...###..##..#.#.##....##...##.#..##..##....#..###...##...#..
                     .###.....#..#..##....#...#.##.#..#.#.#...#..#...#..#.#.###.####..#.###.###.###.#.#..#....#.#.#.#.##.
                     ...##.#.#.#..#..#..#.#.##..#.....#...#####..#####..#.#..#...##..#..#...###.....#...#.#.#....#..##.##
                     .#####.##.##..#...###.#....##...###..#..#...#...########..#.#...#.#..####........####...###...##....
                     .#..#..#.#....##..#.###...#..#.###...##.###.##.#...#####....#.###..#.#..#....#.##..#.......#.....#.#
                     .#..##..#..####..##.#.#..##..###..#.......#...#...#.####.#.#.#..#.##......#.##.###.###.####.##.#.###
                     .##..##.#..##..#.##.###...#.#####.#.#.#.##...#..#...##..##...#..###.###.##..##.#######.###....######
                     ....#.#..##...#..#####...##.#.##......#.###.#.#.###..#...###..##.#..#..####..#.#....#..#.####...#..#
                     .#..##..##...#.####.#####.#######.######.####.......#.#.###.##.#.#.#.#.##.....#....#....#..###....##
                     ###.##..#.#.#.#.#..#######.#.########.#.#.#..####.#####.#.#..##..#..##.....#...#....#.##.##.#....#.#
                     #..#.####.####.##.####...#.###.#.##......###..##.####..#..####..##.#.#....##..##.######...#..##.....
                     #.##...#...#..##...#.#......#..######.#.###.####..#######..#.##...#.#...#.##..###.#####..#...#.####.
                     ##.###.#.######.#...#..##.#...#..##.##.....###..#.##.#..#..####....#.##.##..#.#..#.#....#.....####..
                     .#.##.##.###..#...#.#.#.#.#.......#.####.#####..####.#....##.#...##.##.#.#.##.#..#.###.##..###...#.#
                     #.###.#.##.#.........#..#.#.#.#..##.#..##.#####.###.#.#..#.#.#..##..###..#.##.####.#..#...###.....##
                     ##..#####.#...#.....###.#.#...##.####..#..###....##...#.##.##.##...#.###..#.##...........###.####.##
                     .###....###.#..#.#..#..#.###..########..##......########.#..#######...#........#.#######..####..#..#
                     ####......#...#..#...#.######..#.##.#.##....#.##.#.#.##.#....##...###..##....#.#.##.##.....###.#.##.
                     .#.####.##..##.#.#.#.##.###.##....#..#...#.###.#.#...#.....##..##.####....#..######.#.#.#.##...#...#
                     ...#.##...##..##.###..###....#..##.....#####.#.#..#.....##..##.###..##..##.##.....#.#..##.#..###..#.
                     ..##....####...##.....###.#...#.###...##.#.#..##.###....###.##........#.#..#..##..#.######..##......
                     ###.##.##.#...##.#...###.##.##.######.###.###..###.#....#.#....#.#.#...###..###.#.#...######.#...###
                     ..#.####.########.####.#.#...#..##...##...###..####.###..##..#.##..###..#.####.###..#.#.#.#######..#
                     ###..#.##.##.#..#..#.#..#.###...#...#.##.#####.#.###.#.###.#.##..#...#.#...##...###.....#..###....##
                     ..####.#....####..#.##.....#..#.#.###.###.#.#......#.....####.......##.#.######..####..#######.#..##
                     .##.#.#..#..###....#....#...##.##.###..##.##...#.######......##....##..#.#.#..##..#####....#.#...#..
                     ##...##..#...#.#######..#.....#..##.....#####..#...##.###.####.###..###...#..###........###.##.#.###
                     ...###.#....#...##.....##.####..##.##.#.#..##.######.#..###.##.....##.####..#..##.###.##..###.###..#
                     #.#...##....#....#.##....##...##..#.#...######..###.#.#..#.#.###.#####.#..###....#.##...####..####..
                     #....###.###.#...########.##.##.######.##....#...##.#.#.#..#.##.#.....#..#.....#..........#.##..#...
                     .#.#.#.#.##.##.###...#.#.#...##...#.##.##..#..#...##...##..#.##.#.##....#.###....####..#..###.#..###
                     ...#.#..##.#..##.#.##.####.#.#...###...#.#.###..########.#...###...###..#..#.###..####..##.#..#...#.
                     ##.#...#######.....#.###..#.#..####.##..##.#..##...#.##..##.#####......######.#.#.##.#..####..#.####
                     #.......#.#########...#...#####...##.###.#..##..##..#...##..##.#.#.###.#.##..#...#....##..#.#.#...#.
                     ###..###..#...##.#...####.###..##.###..##..##.##.....#.#.#.####.######........#...#####.....#..#####
                     ##.#.#.########..#.#.##.#####..##.###...#...#.#.##...###.#.###..#..##.#......#.#.#.##.#.#.#....###.#
                     #.##.#..#...##..###..##..#..##..##.###...#.##.##.#.#..........##...##.##..##..#....##.#####..##..#..
                     .#...##.##.#..#.##....#..##.##...#...####.###..##...#...#.##...######.#.##.#.#.##.####.##..#.###.###
                     ##.#.#..#.#.###.#..#.##.#....#....####..#.#..##.#######..##..#...#..####.#####....#.####.#..#.#.###.
                     ....##.##..#.#####.###.#.###.#.#.#.#..#.###.#..######....##.##.....#.#.#...###..###..#..###....##.##
                     #.#######.#..#.#.##.##...#.#..###.##.##..#..###...#.#...#..##.##..##.#.#.##.##.#######.#..#.#..#.#.#
                     ###.....#####..####..#...#..##.#....##.##...##...##..###...#..##..##..####.#.....##.####..#...##....
                     ####..##..##.#...#.###.##...###.#..#...##.##.#...#.##....####.#.#..#...##..##.##..###.......#..#..#.
                     #.#.#####..#....#.#...#..##.##..##..#.####..###.####.####.#####.#.#..###.##....#....#.#.###.#.#..##.
                     ...##...#.#.#####.#.#....##.##..#...##...........#.#....#.##.##.....##..###...#.#####..........##.##
                     .#..#..#.#...#.........####....##........##...#...#######.####.###.###...#....###..#.###.##.#.####.#
                     ..#.#.....#...###.####......###.#..#.#.#.#...####...#####.#..#....#.#.#....#.##.###....#..#....##.##
                     ##.#...##....###.#......####.#.####.##...#..#.#.#.#...#####.#..#..##.#.#...#.####....###.####.#.#.##
                     .#.#..#....#.####.#..#.###..#.#.#.#.#.###...#.##.##.#.##...####..######....####...##.##.#..##.#.#..#
                     ..##.#...##.####..#.###..##..#.###.#.##..##.###.#.#####..#.##.#.....#.#####.####..#.#.######.#.##.#.
                     #.....##..###..###.....###.##.###.#..##.#..##.###....#..#.#.##....#.##.##.#...###.###.#......#..#...
                     .##.#..#...#...#.#..##.....#..#.###....###..#.##...#.##.#.##..##......#.#.#.####.#..#..##...##..##.#
                     ####...##...#......##.##..#######....###.##.#.###.#.#.###...####..#..#.#.##.........#.##.#....#####.
                     .####.#####..##..###..#.##.##.####.......#.###.#####.#..#...#..#..####.#.....#.####.#.....###...####
                     #.##......#.#.#.##....#.#.##..#...#.#.#..#...##..#.##.##..#..#####..###.##.#...##...#..#...##.##..#.
                     .##.#.#.###..###.##....#...###...####...####..##.###.####.###.#..#.###.#..#.....#.##.#..#.##.#.#.#.#
                     ...#.###.#..#..#.###.#....##..##.#..###.######.#...##..#.#...###.....#.###.#.#....##...##.###.#.####
                     .#..#..#....###..##..#....##.##..####.#.#.#..#.######....####.##.##....##.#.#.####.#..#.##.##....#..
                     #..##.#...#.###..#.###..###..#.##.#.######.#.#.####....###.##....#.##.#......##.##...##....#.#.###.#
                     #...##.#.####...#######..#....##.#...##..#.#....#.#.#####.####.##...#.###.##.#.#.##...##.#....##..##
                     ....#.##.#.##.##.#.#..###...##.#.#.#....#...#..........###.#####.##...##..#..#.##.#...#..###..#####.
                     ###..###.##..#.###.#.#.#...##.#.###.##.###...##.###.....####.#...##.#.#.#..#.##...#.....#..#.#.#...#
                     ####...#.####.#.#.#..#.##.##.##.#.#.####...#...#.#..###....##.##..##.###...##.#...#####.###.#..#....
                     ##..##...###..###.#.###.##.####.#..#.#..####.##.#...#..#..#.....##.#.#####...##.....#.#.#..#..##..#.
                     .....#......#..##..#...#.#.#.######....###.##.##..#.###...#...#.####.##.##.###.#.######.#..#.#.##...
                     #.#.#.###........#..#.#.#.#....##..##..###...##.#.##.#..#######.#..###.###.#.###.###.#.#.#.....##..#
                     #.##....####.......#..##.####.#.##..###.##.###.#.#.###...###.....######...######.#.....###.##.......
                     #.##..#...#..#..#....#.##...#..#.###...#...#########.#.#...#.....#...#..#.#...#.#.#...#.###.####..##
                     .#..##........###.#.#....#.......##.#..#.#.#.##.......#.#.#.#..#.#.....#....#.###.#.##...###.....#..
                     .#.#...##...#....#.##..##.#...#.##..#..##.#..###.#####..##.#.##.####.####.###...##....##......###..#
                     #..##....##.###.##.....#.#.....#.#...#..##....##.###.#....###.....######.#.##.###..#..#.#...#.....#.
                     ....#.####.....#..#..#...#.###.#####..##...#.#..###.#...#...##.###.##..#.######..####.#.#....#.#..##
                     ##.#..##.#.#.##..##..#...###..##.##..#.###..#...###..##.#.###.####...#..#.#######.##.###.###.#.#..#.
                     ...##...##.#.#.##.#.##.###..##...##.#..#..##.##.##.##.#.####..##.######....#..#.#.#....###.#.##.#.#.
                     .#.....#.###...##.#.##.#..###.##..####.###..#.#.....#..##.#.#..##...##.#..#.##..#########..#.#.##.#.
                     ####.#..#.#..##...#..#.##..#..#...#.###.....#..##...#..####....#######.....#.##.##..##...#.##..####.
                     ########...#.#.####..####.#.#.#..##.#.#.##...#...#..#...#..###.#.#..##..#####.#.#.#.##.#.###...#.##.
                     .#....#..######.#.#.#..##.#.#...#####....##..##.##.#####....#.##..#..#.#.#.###..#.####.###.........#
                     ...####..##......###..#..###..#.#.###.#...#..####.#.#..###....#..##.####.#..#.....#.........##..###.
                     .####...##...#####.##.##...##...##..##...#.#####...#...##...#.####..####.###.....##.##...##.#######.
                     ##..####....#.#..#.#....##..#####....#.#...#.####..#######..##.#####.#.#.#.##.#.#..#...#.###.##.#.##
                     #.####....#..##########...###.#..#####.#.#.##....#..#....######.....#...#.##.##.#.##..#.###..###..#.
                     ##.#.##.###..#.###.....##..#.###.#....#####.###...#.#.##.#..#.###.#.#.#####.#.##.##.##.#.#.###.###..
                     .###.#.#.##.######.#.#..##.#..####..#....##......#...##.##.#.......#.#.#.####.#.#.##....##.####..#.#
                     ####..#...##....#.#.#....#.#####...#..#....##..#..####...#..###...........####.###.###......#..##..#
                     ..##.####.##....####....#.#.####..#...###.#....#.##.###.#.##..####.#..###..#...#..#####..#...##...#.
                     ...#..#....#.#..##.#.####....#..####...##.#..#####.###..#.##..###.######...#...#...######.##....##..
                     ..#########.#####.#####.###.##.#.###.###..#.#.#.#.###.#...###........####..#####.#.##.##.#..#..#.##.
                     #..###.##.###.#...#.#.#.##.###........#.#.#.#..#..##.##.#.....#.#.....##...#..#.##..#..#..#......#.#
                     ...##..#...##.....##...####.....#.##..###.....#..#.###.#..#.#...#..#.#.....###.###.##.#.#.#..#.#....
                     #...#...#.#.#...#####.####..#....##...##.##.##.#...#.#.#..#...##....#...###.#.##.##....########..#..
                     .#.####....#.#.....########.#....######.#.#######...##..#.###.#.###..###.#..###....#.#.###.....###.#
                     ..#.##.##....#..#...#..#.#.#...###...#..#.#.#.####.#.#####.####....##..#..###.#.#..####....##.####..""";
//        img = """
//              #..#.
//              #....
//              ##..#
//              ..#..
//              ..###""";
//        key = "..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..##" +
//"#..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###" +
//".######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#." +
//".#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#....." +
//".#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.." +
//"...####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#....." +
//"..##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#";
        System.out.println("Part one");
        Image image = new Image();
        String[] rows = img.split("\n");
        for(int y = 0; y<rows.length; y++){
            String row = rows[y];
            for(int x = 0; x<row.length(); x++){
                char c = row.charAt(x);
                int value = c=='#'?1:0;
                image.set(x, y, value);
            }
        }
//        System.out.println(image.toString());
        image = zoomAndEnhance(image, key);
//        System.out.println(image.toString());
        image = zoomAndEnhance(image, key);
//        System.out.println(image.toString());
        System.out.println(image.count(1));
        System.out.println("Part two");
        for(int i = 0; i<48; i++){
            image = zoomAndEnhance(image, key);
//            System.out.println(image.toString());
        }
        System.out.println(image.count(1));
    }
    private Image zoomAndEnhance(Image input, String key){
        input.calcBounds();
        String s = input.toString();
        Image output = new Image();
        for(int x = input.minx-1; x<=input.maxx+1; x++){
            for(int y = input.miny-1; y<=input.maxy+1; y++){
                String num = input.get(x-1, y-1)+""+input.get(x, y-1)+""+input.get(x+1, y-1)+""+
                        input.get(x-1, y)+""+input.get(x, y)+""+input.get(x+1, y)+""+
                        input.get(x-1, y+1)+""+input.get(x, y+1)+""+input.get(x+1, y+1);
                output.set(x, y, key.charAt(Integer.parseInt(num, 2))=='#'?1:0);
            }
        }
        output.defaultVal = key.charAt(Integer.parseInt(input.defaultVal==1?"111111111":"000000000", 2))=='#'?1:0;
//        if(s.equals(input.toString()))System.out.println("and nothing has gone horribly wrong.");
        return output;
    }
    private static class Image{
        public HashMap<Integer, HashMap<Integer, Integer>> grid = new HashMap<>();
        int minx, miny, maxx, maxy;
        int defaultVal = 0;
        public void set(int x, int y, int val){
            HashMap<Integer, Integer> map = grid.get(x);
            if(map==null){
                map = new HashMap<>();
                grid.put(x, map);
            }
            map.put(y, val);
        }
        public int get(int x, int y){
            return grid.getOrDefault(x, new HashMap<>()).getOrDefault(y, defaultVal);
        }
        public void calcBounds(){
            minx = miny = maxx = maxy = 0;
            for(int x : grid.keySet()){
                if(x<minx)minx = x;
                if(x>maxx)maxx = x;
                for(int y : grid.get(x).keySet()){
                    if(y<miny)miny = y;
                    if(y>maxy)maxy = y;
                }
            }
        }
        private long count(int i){
            calcBounds();
            long count = 0;
            for(int y = miny-1; y<=maxy+1; y++){
                for(int x = minx-1; x<=maxx+1; x++){
                    if(get(x,y)==i)count++;
//                    s+=get(x, y)==1?"#":".";
                }
            }
//            for(int x : grid.keySet()){
//                for(int y : grid.get(x).keySet()){
//                    if(grid.get(x).get(y)==i)count++;
//                }
//            }
            return count;
        }
        @Override
        public String toString(){
            calcBounds();
            String s = "";
            for(int y = miny-1; y<=maxy+1; y++){
                for(int x = minx-1; x<=maxx+1; x++){
                    s+=get(x, y)==1?"#":".";
                }
                s+="\n";
            }
            return s;
        }
    }
}